<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeafLoaf Voice - Multi-Language Streaming</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #2d7d46 0%, #4caf50 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 600px;
            width: 90%;
        }
        h1 {
            text-align: center;
            color: #2d7d46;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        .language-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .lang-chip {
            padding: 8px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        .lang-chip.active {
            background: #2d7d46;
            color: white;
            border-color: #2d7d46;
        }
        .status {
            text-align: center;
            padding: 10px;
            margin: 20px 0;
            border-radius: 8px;
            font-weight: 500;
        }
        .connected { background: #e8f5e9; color: #2e7d32; }
        .listening { background: #ffebee; color: #c62828; animation: pulse 1s infinite; }
        .processing { background: #e3f2fd; color: #1565c0; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .mic-button {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: none;
            background: #2d7d46;
            color: white;
            font-size: 50px;
            cursor: pointer;
            margin: 30px auto;
            display: block;
            transition: all 0.3s;
            box-shadow: 0 6px 20px rgba(45, 125, 70, 0.3);
        }
        .mic-button:hover {
            transform: scale(1.05);
        }
        .mic-button.active {
            background: #f44336;
            animation: recording 1.5s infinite;
        }
        @keyframes recording {
            0% { box-shadow: 0 6px 20px rgba(244, 67, 54, 0.3); }
            50% { box-shadow: 0 6px 30px rgba(244, 67, 54, 0.6); }
            100% { box-shadow: 0 6px 20px rgba(244, 67, 54, 0.3); }
        }
        .conversation {
            max-height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 12px;
            margin: 20px 0;
        }
        .message {
            margin: 10px 0;
            padding: 12px 16px;
            border-radius: 12px;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .user { background: #e3f2fd; margin-left: 50px; }
        .assistant { background: #e8f5e9; margin-right: 50px; }
        .interim { opacity: 0.7; font-style: italic; }
        .error { background: #ffebee; color: #c62828; }
        .text-input {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .text-input input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }
        .text-input button {
            padding: 12px 24px;
            background: #2d7d46;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        .visualizer {
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 3px;
            margin: 20px 0;
        }
        .bar {
            width: 4px;
            background: #2d7d46;
            transition: height 0.1s;
            border-radius: 2px;
        }
        .tips {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõí LeafLoaf Voice Assistant</h1>
        <p class="subtitle">Real-time streaming in your language</p>
        
        <div class="language-selector">
            <span class="lang-chip active" data-lang="en-US" onclick="setLanguage('en-US')">English</span>
            <span class="lang-chip" data-lang="es-US" onclick="setLanguage('es-US')">Espa√±ol</span>
            <span class="lang-chip" data-lang="hi-IN" onclick="setLanguage('hi-IN')">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</span>
            <span class="lang-chip" data-lang="zh-CN" onclick="setLanguage('zh-CN')">‰∏≠Êñá</span>
            <span class="lang-chip" data-lang="ar-SA" onclick="setLanguage('ar-SA')">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</span>
            <span class="lang-chip" data-lang="bn-IN" onclick="setLanguage('bn-IN')">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</span>
            <span class="lang-chip" data-lang="ta-IN" onclick="setLanguage('ta-IN')">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</span>
            <span class="lang-chip" data-lang="ko-KR" onclick="setLanguage('ko-KR')">ÌïúÍµ≠Ïñ¥</span>
            <span class="lang-chip" data-lang="ja-JP" onclick="setLanguage('ja-JP')">Êó•Êú¨Ë™û</span>
            <span class="lang-chip" data-lang="vi-VN" onclick="setLanguage('vi-VN')">Ti·∫øng Vi·ªát</span>
        </div>
        
        <div class="status connected" id="status">Connected - Click mic to start</div>
        
        <button class="mic-button" id="micBtn" onclick="toggleRecording()">üé§</button>
        
        <div class="visualizer" id="visualizer"></div>
        
        <div class="conversation" id="conversation">
            <div class="message assistant">
                Welcome! I can help you shop for groceries in multiple languages. Just press the mic and speak!
            </div>
        </div>
        
        <div class="text-input">
            <input type="text" id="textInput" placeholder="Or type your message..." onkeypress="handleKeyPress(event)">
            <button onclick="sendText()">Send</button>
        </div>
        
        <div class="tips">
            <strong>Try saying:</strong> "I need milk" ‚Ä¢ "Show me organic vegetables" ‚Ä¢ "What's on sale?" ‚Ä¢ "Add bananas to cart"
        </div>
    </div>

    <script>
        let ws = null;
        let isRecording = false;
        let mediaRecorder = null;
        let currentLanguage = 'en-US';
        let audioContext = null;
        let analyser = null;
        let animationId = null;

        // Connect on load
        window.addEventListener('load', () => {
            connectWebSocket();
            setupVisualizer();
        });

        function connectWebSocket() {
            ws = new WebSocket('ws://localhost:8080/api/v1/voice/hybrid/stream');
            
            ws.onopen = () => {
                console.log('Connected to hybrid voice streaming');
                updateStatus('Connected - Click mic to start', 'connected');
            };
            
            ws.onmessage = async (event) => {
                if (typeof event.data === 'string') {
                    const data = JSON.parse(event.data);
                    handleMessage(data);
                }
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                updateStatus('Connection error', 'connected');
            };
            
            ws.onclose = () => {
                updateStatus('Disconnected - Reconnecting...', 'connected');
                setTimeout(connectWebSocket, 2000);
            };
        }

        function handleMessage(data) {
            switch (data.type) {
                case 'connected':
                    console.log('Service ready:', data.capabilities);
                    break;
                    
                case 'transcript':
                    if (data.is_final) {
                        addMessage(data.text, 'user');
                    } else {
                        updateInterimTranscript(data.text);
                    }
                    break;
                    
                case 'processing':
                    updateStatus(data.message, 'processing');
                    break;
                    
                case 'response':
                    addMessage(data.text, 'assistant');
                    updateStatus('Connected - Click mic to start', 'connected');
                    break;
                    
                case 'audio':
                    playAudio(data.data, data.format);
                    break;
                    
                case 'error':
                    addMessage(`Error: ${data.message}`, 'error');
                    break;
                    
                case 'listening_started':
                    updateStatus('Listening... Speak now', 'listening');
                    break;
                    
                case 'listening_stopped':
                    updateStatus('Processing...', 'processing');
                    break;
            }
        }

        async function toggleRecording() {
            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        channelCount: 1,
                        sampleRate: 48000,
                        echoCancellation: true,
                        noiseSuppression: true
                    } 
                });
                
                // Setup audio context for visualization
                audioContext = new AudioContext();
                analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);
                
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm;codecs=opus'
                });
                
                mediaRecorder.ondataavailable = async (event) => {
                    if (event.data.size > 0 && ws && ws.readyState === WebSocket.OPEN) {
                        const arrayBuffer = await event.data.arrayBuffer();
                        ws.send(arrayBuffer);
                    }
                };
                
                mediaRecorder.start(100); // Send chunks every 100ms
                isRecording = true;
                
                // Notify server
                ws.send(JSON.stringify({ type: 'start_listening' }));
                
                // Update UI
                document.getElementById('micBtn').classList.add('active');
                startVisualization();
                
            } catch (error) {
                console.error('Microphone error:', error);
                addMessage('Microphone access denied', 'error');
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'stop_listening' }));
            }
            
            isRecording = false;
            document.getElementById('micBtn').classList.remove('active');
            stopVisualization();
            
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
        }

        function setLanguage(lang) {
            currentLanguage = lang;
            
            // Update UI
            document.querySelectorAll('.lang-chip').forEach(chip => {
                chip.classList.toggle('active', chip.dataset.lang === lang);
            });
            
            // Notify server
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'set_language',
                    language: lang
                }));
            }
        }

        function sendText() {
            const input = document.getElementById('textInput');
            const text = input.value.trim();
            
            if (text && ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'text',
                    text: text
                }));
                
                addMessage(text, 'user');
                input.value = '';
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendText();
            }
        }

        function updateStatus(text, className) {
            const status = document.getElementById('status');
            status.textContent = text;
            status.className = 'status ' + className;
        }

        function addMessage(text, type) {
            const conversation = document.getElementById('conversation');
            
            // Remove any interim transcript
            const interim = conversation.querySelector('.interim');
            if (interim) interim.remove();
            
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.textContent = text;
            conversation.appendChild(message);
            conversation.scrollTop = conversation.scrollHeight;
        }

        function updateInterimTranscript(text) {
            const conversation = document.getElementById('conversation');
            let interim = conversation.querySelector('.interim');
            
            if (!interim) {
                interim = document.createElement('div');
                interim.className = 'message user interim';
                conversation.appendChild(interim);
            }
            
            interim.textContent = text;
            conversation.scrollTop = conversation.scrollHeight;
        }

        function playAudio(base64Data, format) {
            const audio = new Audio(`data:audio/${format};base64,${base64Data}`);
            audio.play().catch(e => console.error('Audio playback error:', e));
        }

        function setupVisualizer() {
            const visualizer = document.getElementById('visualizer');
            for (let i = 0; i < 20; i++) {
                const bar = document.createElement('div');
                bar.className = 'bar';
                bar.style.height = '4px';
                visualizer.appendChild(bar);
            }
        }

        function startVisualization() {
            if (!analyser) return;
            
            const bars = document.querySelectorAll('.bar');
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            
            function draw() {
                animationId = requestAnimationFrame(draw);
                analyser.getByteFrequencyData(dataArray);
                
                bars.forEach((bar, i) => {
                    const value = dataArray[i * 10] || 0;
                    const height = Math.max(4, (value / 255) * 50);
                    bar.style.height = `${height}px`;
                });
            }
            
            draw();
        }

        function stopVisualization() {
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            
            document.querySelectorAll('.bar').forEach(bar => {
                bar.style.height = '4px';
            });
        }
    </script>
</body>
</html>