<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeafLoaf Voice Demo - Streaming</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f7fa;
        }
        
        .container {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2e7d32;
            text-align: center;
            margin-bottom: 10px;
            font-size: 32px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 40px;
        }
        
        .recording-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .mic-button {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #4caf50, #2e7d32);
            color: white;
            font-size: 48px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 20px rgba(76, 175, 80, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .mic-button:hover {
            transform: scale(1.05);
        }
        
        .mic-button.recording {
            background: linear-gradient(135deg, #f44336, #c62828);
            animation: pulse 1.5s infinite;
        }
        
        .mic-button.processing {
            background: linear-gradient(135deg, #ff9800, #f57c00);
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(244, 67, 54, 0); }
            100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); }
        }
        
        .status {
            text-align: center;
            font-size: 18px;
            color: #666;
            margin-bottom: 30px;
            min-height: 30px;
        }
        
        .conversation {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            min-height: 300px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .message {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            margin-left: 40px;
        }
        
        .assistant-message {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            margin-right: 40px;
        }
        
        .products {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .product-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            transition: all 0.2s;
        }
        
        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .product-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .product-price {
            color: #4caf50;
            font-size: 18px;
            font-weight: 500;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
        
        .instructions {
            background: #e3f2fd;
            color: #1565c0;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .recording-time {
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🥬 LeafLoaf Voice Assistant</h1>
        <p class="subtitle">Your AI-powered grocery shopping companion</p>
        
        <div class="instructions">
            🎤 Click and hold the microphone to speak. Release to process your request.
            <br>Try saying: "I need organic milk and fresh vegetables"
        </div>
        
        <div class="recording-controls">
            <button class="mic-button" id="micButton">
                <span id="micIcon">🎤</span>
                <span class="recording-time" id="recordingTime"></span>
            </button>
        </div>
        
        <div class="status" id="status">Ready to listen</div>
        
        <div class="conversation" id="conversation">
            <div class="message assistant-message">
                Welcome! Press and hold the microphone button, then speak naturally about what groceries you need.
            </div>
        </div>
        
        <div class="error" id="error"></div>
    </div>
    
    <script>
        let mediaRecorder = null;
        let audioChunks = [];
        let recordingStartTime = null;
        let recordingTimer = null;
        
        const micButton = document.getElementById('micButton');
        const micIcon = document.getElementById('micIcon');
        const status = document.getElementById('status');
        const conversation = document.getElementById('conversation');
        const error = document.getElementById('error');
        const recordingTime = document.getElementById('recordingTime');
        
        // Mouse/Touch events for press-and-hold
        micButton.addEventListener('mousedown', startRecording);
        micButton.addEventListener('mouseup', stopRecording);
        micButton.addEventListener('mouseleave', stopRecording);
        micButton.addEventListener('touchstart', startRecording);
        micButton.addEventListener('touchend', stopRecording);
        
        async function startRecording(e) {
            e.preventDefault();
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    } 
                });
                
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = processAudio;
                
                mediaRecorder.start();
                
                // Update UI
                micButton.classList.add('recording');
                micIcon.textContent = '🔴';
                status.textContent = 'Recording... Release to send';
                hideError();
                
                // Start timer
                recordingStartTime = Date.now();
                updateRecordingTime();
                
            } catch (err) {
                console.error('Error accessing microphone:', err);
                showError('Failed to access microphone. Please check permissions.');
            }
        }
        
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                
                micButton.classList.remove('recording');
                micButton.classList.add('processing');
                micIcon.textContent = '⏳';
                status.textContent = 'Processing...';
                
                clearInterval(recordingTimer);
                recordingTime.textContent = '';
            }
        }
        
        function updateRecordingTime() {
            recordingTimer = setInterval(() => {
                if (recordingStartTime) {
                    const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                    recordingTime.textContent = `${elapsed}s`;
                }
            }, 100);
        }
        
        async function processAudio() {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            
            // Convert to base64
            const reader = new FileReader();
            reader.onloadend = async () => {
                const base64Audio = reader.result.split(',')[1];
                
                try {
                    // Send to server with streaming
                    const response = await fetch('/api/v1/voice-stream/process', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            audio_base64: base64Audio,
                            user_id: 'demo_user_' + Date.now()
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Server error');
                    }
                    
                    // Process streaming response
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.slice(6));
                                    handleStreamEvent(data);
                                } catch (e) {
                                    // Ignore parse errors
                                }
                            }
                        }
                    }
                    
                } catch (err) {
                    console.error('Processing error:', err);
                    showError('Failed to process audio. Please try again.');
                } finally {
                    micButton.classList.remove('processing');
                    micIcon.textContent = '🎤';
                    status.textContent = 'Ready to listen';
                }
            };
            
            reader.readAsDataURL(audioBlob);
        }
        
        function handleStreamEvent(data) {
            switch (data.type) {
                case 'status':
                    status.textContent = data.message;
                    break;
                    
                case 'transcript':
                    addMessage(data.text, 'user');
                    status.textContent = `Transcript: "${data.text}" (${Math.round(data.confidence * 100)}% confident)`;
                    break;
                    
                case 'searching':
                    status.textContent = `Searching for: "${data.query}"`;
                    break;
                    
                case 'results':
                    displayResults(data);
                    break;
                    
                case 'error':
                    showError(data.message);
                    break;
                    
                case 'complete':
                    status.textContent = 'Ready for next query';
                    break;
            }
        }
        
        function addMessage(text, type) {
            const message = document.createElement('div');
            message.className = `message ${type}-message`;
            message.textContent = text;
            conversation.appendChild(message);
            conversation.scrollTop = conversation.scrollHeight;
        }
        
        function displayResults(data) {
            const message = document.createElement('div');
            message.className = 'message assistant-message';
            
            if (data.count === 0) {
                message.textContent = `No products found for "${data.query}". Try describing it differently!`;
            } else {
                message.innerHTML = `Found ${data.count} products for "${data.query}":`;
                
                const productsGrid = document.createElement('div');
                productsGrid.className = 'products';
                
                data.products.forEach(product => {
                    const card = document.createElement('div');
                    card.className = 'product-card';
                    card.innerHTML = `
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">$${product.price.toFixed(2)}</div>
                        ${product.unit ? `<div style="color: #666; font-size: 14px;">${product.unit}</div>` : ''}
                    `;
                    productsGrid.appendChild(card);
                });
                
                message.appendChild(productsGrid);
            }
            
            conversation.appendChild(message);
            conversation.scrollTop = conversation.scrollHeight;
        }
        
        function showError(msg) {
            error.textContent = msg;
            error.style.display = 'block';
            setTimeout(hideError, 5000);
        }
        
        function hideError() {
            error.style.display = 'none';
        }
    </script>
</body>
</html>