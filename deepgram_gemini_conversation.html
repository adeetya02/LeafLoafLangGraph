<!DOCTYPE html>
<html>
<head>
    <title>Deepgram + Gemini Conversational AI</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { text-align: center; color: #333; }
        .api-keys {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .api-keys input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            display: block;
            margin: 20px auto;
            padding: 15px 30px;
            font-size: 18px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover { background: #45a049; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        #status {
            text-align: center;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            background: #f0f0f0;
        }
        #conversation {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 5px;
            min-height: 300px;
            margin: 20px 0;
            border: 1px solid #ddd;
            max-height: 500px;
            overflow-y: auto;
        }
        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
        }
        .user {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            margin-left: 20%;
        }
        .assistant {
            background: #f3e5f5;
            border-left: 4px solid #9c27b0;
            margin-right: 20%;
        }
        .system {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            text-align: center;
            font-size: 14px;
        }
        .interim { 
            opacity: 0.6; 
            font-style: italic;
        }
        .thinking {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¤ LeafLoaf Voice Assistant</h1>
        <p style="text-align: center;">Powered by Deepgram + Google Gemini</p>
        
        <div class="api-keys">
            <label>Gemini API Key (Get free at <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a>):</label>
            <input type="password" id="geminiKey" placeholder="Enter your Gemini API key">
            <small>Your key is stored locally and never sent to any server</small>
        </div>
        
        <button id="startBtn" onclick="startConversation()">Start Conversation</button>
        <button id="stopBtn" onclick="stopConversation()" style="display: none;">Stop</button>
        
        <div id="status">Enter your Gemini API key and click Start</div>
        
        <div id="conversation">
            <div class="message system">Conversation will appear here...</div>
        </div>
    </div>

    <script>
        let sttWebsocket = null;
        let mediaRecorder = null;
        let audioStream = null;
        let isProcessing = false;
        let conversationHistory = [];
        
        const DEEPGRAM_API_KEY = '36a821d351939023aabad9beeaa68b391caa124a';
        
        // System prompt for Gemini
        const SYSTEM_PROMPT = `You are a friendly and helpful grocery shopping assistant for LeafLoaf. 
Your role is to:
1. Help customers find products they need
2. Answer questions about groceries
3. Assist with their shopping list
4. Be conversational and natural

Keep responses concise (2-3 sentences max) since they will be spoken aloud.
When customers ask about products, mention 2-3 specific options with prices when possible.
Be warm and personable - you can respond to greetings and casual conversation too.`;
        
        async function generateResponse(userInput) {
            const geminiKey = document.getElementById('geminiKey').value;
            if (!geminiKey) {
                return "I need your Gemini API key to have a conversation. Please enter it above.";
            }
            
            try {
                // Show thinking indicator
                addMessage("Thinking...", 'thinking', 'thinking-msg');
                
                // Prepare conversation context
                const messages = conversationHistory.slice(-10).map(msg => ({
                    role: msg.role === 'assistant' ? 'model' : 'user',
                    parts: [{ text: msg.content }]
                }));
                
                // Add current message
                messages.push({
                    role: 'user',
                    parts: [{ text: userInput }]
                });
                
                // Call Gemini API
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=${geminiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [
                            {
                                role: 'user',
                                parts: [{ text: SYSTEM_PROMPT }]
                            },
                            ...messages
                        ],
                        generationConfig: {
                            temperature: 0.7,
                            maxOutputTokens: 150,
                        }
                    })
                });
                
                // Remove thinking indicator
                const thinkingMsg = document.getElementById('thinking-msg');
                if (thinkingMsg) thinkingMsg.remove();
                
                if (!response.ok) {
                    throw new Error(`Gemini API error: ${response.status}`);
                }
                
                const data = await response.json();
                const reply = data.candidates[0].content.parts[0].text;
                
                return reply;
                
            } catch (error) {
                console.error('Gemini error:', error);
                // Remove thinking indicator
                const thinkingMsg = document.getElementById('thinking-msg');
                if (thinkingMsg) thinkingMsg.remove();
                
                return "I'm having trouble connecting to my AI brain. Let me try to help anyway - what grocery items are you looking for?";
            }
        }
        
        async function startConversation() {
            const status = document.getElementById('status');
            const conversation = document.getElementById('conversation');
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            
            try {
                status.textContent = 'Getting microphone access...';
                conversation.innerHTML = '';
                conversationHistory = [];
                
                // Get microphone
                audioStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        channelCount: 1,
                        sampleRate: 16000,
                        echoCancellation: true,
                        noiseSuppression: true
                    } 
                });
                
                status.textContent = 'Connecting to Deepgram STT...';
                
                // Connect to Deepgram STT
                const sttUrl = 'wss://api.deepgram.com/v1/listen?' + new URLSearchParams({
                    model: 'nova-2',
                    language: 'en-US',
                    smart_format: 'true',
                    interim_results: 'true',
                    utterance_end_ms: '1000',
                    vad_events: 'true'
                });
                
                sttWebsocket = new WebSocket(sttUrl, ['token', DEEPGRAM_API_KEY]);
                
                sttWebsocket.onopen = () => {
                    status.textContent = 'âœ… Connected! Start speaking...';
                    startBtn.style.display = 'none';
                    stopBtn.style.display = 'block';
                    
                    const greeting = "Hello! Welcome to LeafLoaf. How can I help you with your grocery shopping today?";
                    addMessage(greeting, 'assistant');
                    speak(greeting);
                    
                    // Start recording
                    mediaRecorder = new MediaRecorder(audioStream);
                    
                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0 && sttWebsocket.readyState === WebSocket.OPEN) {
                            sttWebsocket.send(event.data);
                        }
                    };
                    
                    mediaRecorder.start(250);
                };
                
                let currentInterimId = null;
                
                sttWebsocket.onmessage = async (event) => {
                    const response = JSON.parse(event.data);
                    
                    if (response.channel && response.channel.alternatives && response.channel.alternatives.length > 0) {
                        const text = response.channel.alternatives[0].transcript;
                        
                        if (text) {
                            if (response.is_final) {
                                // Remove interim message
                                if (currentInterimId) {
                                    const elem = document.getElementById(currentInterimId);
                                    if (elem) elem.remove();
                                    currentInterimId = null;
                                }
                                
                                // Add user message
                                addMessage(text, 'user');
                                
                                // Process and respond
                                if (!isProcessing) {
                                    isProcessing = true;
                                    
                                    // Generate response with Gemini
                                    const response = await generateResponse(text);
                                    
                                    // Add assistant message
                                    addMessage(response, 'assistant');
                                    
                                    // Speak the response
                                    await speak(response);
                                    
                                    isProcessing = false;
                                }
                            } else {
                                // Show interim result
                                if (!currentInterimId) {
                                    currentInterimId = 'interim-' + Date.now();
                                    const div = document.createElement('div');
                                    div.id = currentInterimId;
                                    div.className = 'message user interim';
                                    div.textContent = text + '...';
                                    document.getElementById('conversation').appendChild(div);
                                } else {
                                    const elem = document.getElementById(currentInterimId);
                                    if (elem) elem.textContent = text + '...';
                                }
                            }
                        }
                    }
                };
                
                sttWebsocket.onerror = (error) => {
                    console.error('STT WebSocket error:', error);
                    status.textContent = 'âŒ Connection error';
                    stopConversation();
                };
                
                sttWebsocket.onclose = () => {
                    status.textContent = 'Disconnected';
                    stopConversation();
                };
                
            } catch (error) {
                console.error('Error:', error);
                status.textContent = 'âŒ Error: ' + error.message;
            }
        }
        
        async function speak(text) {
            try {
                // Use Deepgram TTS API
                const ttsUrl = 'https://api.deepgram.com/v1/speak?' + new URLSearchParams({
                    model: 'aura-asteria-en',
                    encoding: 'mp3'
                });
                
                const response = await fetch(ttsUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Token ' + DEEPGRAM_API_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text })
                });
                
                if (response.ok) {
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    
                    // Wait for audio to finish playing
                    return new Promise((resolve) => {
                        audio.onended = () => {
                            URL.revokeObjectURL(audioUrl);
                            resolve();
                        };
                        audio.play();
                    });
                }
            } catch (error) {
                console.error('TTS error:', error);
                // Continue even if TTS fails
            }
        }
        
        function addMessage(text, type, id = null) {
            const conversation = document.getElementById('conversation');
            const div = document.createElement('div');
            div.className = 'message ' + type;
            div.textContent = text;
            if (id) div.id = id;
            conversation.appendChild(div);
            conversation.scrollTop = conversation.scrollHeight;
            
            // Add to history (except thinking messages)
            if (type !== 'thinking') {
                conversationHistory.push({ role: type, content: text });
            }
        }
        
        function stopConversation() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
            }
            
            if (sttWebsocket) {
                sttWebsocket.close();
            }
            
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('status').textContent = 'Stopped';
        }
        
        // Load saved API key
        window.onload = () => {
            const savedKey = localStorage.getItem('geminiApiKey');
            if (savedKey) {
                document.getElementById('geminiKey').value = savedKey;
            }
        };
        
        // Save API key when entered
        document.getElementById('geminiKey').addEventListener('change', (e) => {
            localStorage.setItem('geminiApiKey', e.target.value);
        });
    </script>
</body>
</html>